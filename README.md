# OPARL - Online Mario Level Generation from Music

This is the code for the paper "Online Game Level Generation from Music" in proceedings of the 2022 IEEE Conference on Games, in which we proposed a procedural content generation (PCG) framework named **O**nline **P**layer **A**daptive **R**einforcement **L**earning (OPARL) to generate _Super Mario Bros_ (SMB) game level from music in an online manner. [PDF file](https://ieee-cog.org/2022/assets/papers/paper_49.pdf) and [Presentation video](https://ieee-cog.org/2022/assets/video/PCG%20I-49.mp4) of this paper are available at the [CoG 2022 website](https://ieee-cog.org/2022/).

Please use the following bibtex if you use this repository in your work:

````
@inproceedings{wang2022online,
  title={Online Game Level Generation from Music},
  author={Wang, Ziqi and Liu, Jialin},
  booktitle = {Conference on Games},
  year={2022},
  pages={Accepted},
  organization={IEEE}
}
````
* **A demo video of A\* agent playing a level generated by our method from a piece of blended music is accessible in this repository:** https://github.com/SUSTechGameAI/OPARL/blob/master/blended%20music-demo.mp4
* **Slides of the presentation at CoG 2022 is available at the root directory of this repository (Presentation Slides at CoG2022.pptx)**

### Discussions about this project
1. **Choice of game:** In this work we use SMB as testbed, as [Mario-AI-Framework](https://github.com/amidos2006/Mario-AI-Framework) is a convenient and widely used platform in PCG researches. However, we have to admit that SMB is not a proper choice for "online game level generation from music". One major reason is that in SMB there is hardly any things that motivates the player to complete the level as fast as possible. Players may just stay at the same place no matter how the atmosphere created by the music changes. As far as the authors know, [_Electronic Super Joy: Groove City_](https://store.steampowered.com/app/301460/Electronic_Super_Joy_Groove_City/) is a platformer game that is suitable for "online game level generation from music". Because this game emphasises the interplay between level and music originally and have some game mechanics that force player keep running non-stop. Beyond the platformer games (and the rhythm game which directly mapping music to game contents), bullet hell games (e.g. the _Touhou project_ series) is another game genre that we think is suitable for "online game level generation from music". It is said that a commercial bullet hell game [_弹幕音乐绘 ～风雷幻奏曲～ (Barrage Musical ～A Fantasy of Tempest～)_](https://store.steampowered.com/app/665270/___Barrage_Musical__A_Fantasy_of_Tempest/) "synchronise game with music".
![](https://cdn.akamai.steamstatic.com/steam/apps/301460/ss_99271095fcc151cf0654eea59d9cfb3be29d46da.jpg?t=1447361872)
**A screenshot of *Electronic Super Joy: Groove City*, borrowed from the steam webpage. Missiles are tracking the player, forcing player keeps running non-stop.**

1. **Potentials of OPARL framework:** In the CoG paper we only maps the difficulty of level with the "energy" of music. But our framework can be compatible with any mapping function between any features of level and music. It is also possible to employ multiple feature mappings. Moreover, other types of game content, such as _gameplay_ and _visual_, could be taken into consider in the whole system. The framework can also be adapted to other play-adaptive tasks in online PCG. For example, dynamic difficulty adjustment can be achieved by replacing the "controller" in OPARL with some other one.

### Environments that have been tested
* Python 3.9.6
* JPype 1.3.0
* pygame 2.0.1
* librosa 0.9.1
* dtw 1.4.0
* scipy 1.7.2
* torch 1.9.0+cu111
* numpy 1.20.3
* gym 0.21.0
### How to use
#### Instructions to play with your own music:
1. **Generate level feature sequence:** Modify the "music_path" in line-36 of *map_feature.py* to the path of your music, then run *map_feature.py*. You will have a json file "{your music's name}_diffs.json" at the same path of your music. 
     * You can customise music feature extracting and feature mapping functions by modifying the "extract_music_feature" and "map_features" functions in *map_feature.py*. 
     * You can also customise the level feature extracting function by modifying "src/level_diffs.py". **Note changing level feature extracting function requires re-train the RL designer!**
2. Copy both your music and json file into "{root path of this project}/assets/online_music/{filename of your music (with extension name)}"
3. Modify the "music_fname" arguments in line-12 of *play.py* to the filename of your music (with extension name), then run it. It may take a while to do initialization.

#### Training GAN generator:
Run command line instruction:
````
At the root path of this project> python train.py generator
````
You can check the running arguments (to specify algorithm parameters) by:
````
At the root path of this project> python train.py generator --help
````
#### Training CNet:
Run command line instruction:
````
At the root path of this project> python train.py cnet
````
You can check the running arguments (to specify algorithm parameters) by:
````
At the root path of this project> python train.py cnet --help
````
#### Training CNet:
Run command line instruction:
````
At the root path of this project> python train.py designer
````
You can check the running arguments (to specify algorithm parameters) by:
````
At the root path of this project> python train.py designer --help
````
#### Play a level:
You may modify the path of level file in line 322 of the _smb.py_, and then run _smb.py_ to play any level stored in a Mario-AI-Framework-supported text file.
* Line 278 of _smb.py_
````
    lvl = MarioLevel.from_txt('Path of your level file')
````
The path can be either related (to project root) or absolute, and the file type won't be checked.